name: CI
run-name: |
  CI: ${{
    github.event_name == 'pull_request' && format('PR #{0} by @{1} - {2}', github.event.pull_request.number, github.actor, github.event.pull_request.title) ||
    github.event_name == 'push' && github.event.head_commit && format('Push by @{0} - {1}', github.actor, github.event.head_commit.message) ||
    format('{0} triggered by @{1}', github.event_name, github.actor)
  }}

on:
  push:
    branches:
      - main
    paths:
      - "build.sh"
      - "scripts/**"
      - "flatpak/**"
      - ".github/workflows/**"
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-flags:
    name: Test Flags Parsing
    uses: ./.github/workflows/test-flags.yml

  build-amd64:
    name: Build Packages (amd64 - ${{ matrix.flags || 'defaults' }})
    needs: test-flags

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            flags: ""
            artifact_suffix: "deb"
          - arch: amd64
            flags: "--build appimage --clean no"
            artifact_suffix: "appimage"

    uses: ./.github/workflows/build-amd64.yml
    with:
      build_flags: ${{ matrix.flags }}
      artifact_suffix: ${{ matrix.artifact_suffix }}

  build-arm64:
    name: Build Packages (arm64 - ${{ matrix.flags || 'defaults' }})
    needs: test-flags

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            flags: "--clean no"
            artifact_suffix: "deb"
          - arch: arm64
            flags: "--build appimage"
            artifact_suffix: "appimage"

    uses: ./.github/workflows/build-arm64.yml
    with:
      build_flags: ${{ matrix.flags }}
      artifact_suffix: ${{ matrix.artifact_suffix }}

  build-flatpak:
    name: Build Flatpak (amd64)
    needs: test-flags

    uses: ./.github/workflows/build-flatpak.yml
    with:
      build_flags: "--clean no"
      artifact_suffix: "flatpak"

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test-flags, build-amd64, build-arm64, build-flatpak]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download AMD64 deb artifact
        uses: actions/download-artifact@v4
        with:
          name: package-amd64-deb
          path: artifacts/

      - name: Download AMD64 AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: package-amd64-appimage
          path: artifacts/

      - name: Download ARM64 deb artifact
        uses: actions/download-artifact@v4
        with:
          name: package-arm64-deb
          path: artifacts/

      - name: Download ARM64 AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: package-arm64-appimage
          path: artifacts/

      - name: Download Flatpak artifact
        uses: actions/download-artifact@v4
        with:
          name: package-amd64-flatpak
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
